# AstrBot QQ邮箱入群验证插件 (astrbot_plugin_qq_email_verify)

## 📖 简介

这是一个为 AstrBot 设计的 QQ 群入群验证插件。当新成员加入群聊时，插件会自动向其 QQ 邮箱（`QQ号@qq.com`）发送包含 6 位数字验证码的邮件。用户需要在规定时间内在群聊中发送正确的验证码以完成验证，否则将被自动移出群聊。

### ✨ 主要功能

*   **自动发送邮件**：新成员入群即刻发送验证邮件，无需人工干预。
*   **超时自动踢出**：支持设置验证超时时间（默认 5 分钟），超时未验证自动踢人。
*   **验证码重发**：支持使用 `/验证码` 指令重新获取验证码，并可指定发送到其他邮箱。
*   **多验证码有效**：重发验证码后，新旧验证码在有效期内均可使用。
*   **高度自定义**：支持自定义邮件主题、邮件模板、群内欢迎语、验证成功/失败提示语。
*   **群信息展示**：邮件模板支持显示群名称和群号，防止用户混淆。

---

## ⚙️ 配置教程

### 1. 安装插件
将插件文件夹放置在 AstrBot 的 `data/plugins/` 目录下，或者通过 AstrBot 的插件管理功能进行安装。

### 2. 插件配置
在 AstrBot 的 Web 管理面板中，找到 **QQ邮箱入群验证** 插件，点击配置按钮。

| 配置项 | 说明 | 默认值 |
| :--- | :--- | :--- |
| **smtp_host** | SMTP 服务器地址 | `smtp.qq.com` |
| **smtp_port** | SMTP 端口 (SSL) | `465` |
| **username** | SMTP 用户名 (通常是你的发件邮箱) | 无 |
| **password** | SMTP 密码 (QQ邮箱请填写授权码) | 无 |
| **use_ssl** | 是否启用 SSL | `True` |
| **from_address** | 发件人邮箱地址 | 无 |
| **from_display_name** | 发件人显示名称 | `AstrBot验证助手` |
| **kick_delay_seconds** | 验证超时时间 (秒) | `300` |
| **verify_email_template** | 邮件内容模板 (支持 HTML) | (见默认配置) |
| **welcome_msg_template** | 群内欢迎语模板 | (见默认配置) |
| **whitelist_groups** | 白名单群号 (仅在这些群启用，优先级高) | `[]` |
| **blacklist_groups** | 黑名单群号 (在这些群不启用) | `[]` |

> 备注 验证邮件内容模板： (支持HTML, {code}为验证码, {group_name}为群名, {group_id}为群号, {timeout}为超时分钟)
> 群内欢迎提示语: ({at_user}为@用户占位符, {timeout}为超时时间(分钟))
---
> **注意**：
> 1. 如果配置了 `whitelist_groups`，则**只有**白名单内的群会开启验证，忽略黑名单。
> 2. 如果未配置白名单，但配置了 `blacklist_groups`，则**除了**黑名单内的群，其他群都会开启验证。
> 3. 如果两者都未配置，则默认在所有群开启验证。
> 4. 为了确保插件正常工作，请务必正确配置 SMTP 服务。

---

## 🔑 QQ邮箱 SMTP 授权码获取

如果你使用 QQ 邮箱作为发件邮箱，**不是 QQ 密码！！！**，必须使用**授权码**。
### 参照图片操作
1.  <img width="1919" height="1079" alt="image" src="https://github.com/user-attachments/assets/35152102-54cb-4779-8961-cfe0b1b60528" />

2.  <img width="1919" height="1079" alt="image" src="https://github.com/user-attachments/assets/37a7b775-a2ca-410a-ab65-6d1ab9ddb991" />

3.  根据提示发送验证码后，就获取到了授权码
<img width="1916" height="1079" alt="屏幕截图 2026-02-25 230217" src="https://github.com/user-attachments/assets/e855644a-63b7-4680-9798-f8dfae5f8071" />

---

## 💬 指令说明

| 指令 | 别名 | 权限 | 说明 |
| :--- | :--- | :--- | :--- |
| `/验证码` | `/验证码重发` | 待验证用户 | 重新向 QQ 邮箱发送验证码 |
| `/验证码 <邮箱>` | `/验证码重发 <邮箱>` | 待验证用户 | 向指定的邮箱发送验证码 |

**示例：**
*   用户发送 `/验证码`：插件向 `123456@qq.com` 发送新验证码。
*   用户发送 `/验证码 test@example.com`：插件向 `test@example.com` 发送新验证码。

---

## 📝 模板变量说明

在自定义邮件模板和提示语时，可以使用以下占位符：

*   **邮件模板 (`verify_email_template`)**:
    *   `{code}`: 6位数字验证码
    *   `{group_name}`: 当前群聊名称
    *   `{group_id}`: 当前群号
    *   `{timeout}`: 超时时间（分钟）

*   **群内提示语 (`welcome_msg_template`)**:
    *   `{at_user}`: 艾特用户的 CQ 码
    *   `{timeout}`: 超时时间（分钟）

---

## ⚠️ 注意事项

1.  **管理员权限**：请确保机器人在群内拥有**管理员**或**群主**权限，否则无法执行踢人操作。
2.  **发信频率**：QQ 邮箱对发信频率有一定的限制，如果短时间内大量入群，可能会导致邮件发送失败。建议申请群验证时适当控制频率。
